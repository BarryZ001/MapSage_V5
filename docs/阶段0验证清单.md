# 阶段0验证清单 - 燧原T20适配与基准验证

## 📋 完成进度追踪

### ✅ 已完成
- [x] 将GitHub代码库克隆到新服务器的Docker容器中
- [x] 创建适配指导文档
- [x] 创建自动适配脚本
- [x] 获取燧原技术信息（基于T20环境配置手册）
- [x] 创建路径配置更新脚本
- [x] 创建权重文件准备指导

### 🔄 进行中
- [ ] 准备权重文件
- [ ] 更新路径配置
- [ ] 执行代码适配

### ⏳ 待完成

#### 1. ✅ 燧原技术信息（已确认）

**基于T20环境配置手册的关键信息：**
- [x] **设备标识符**：`ptex.device('xla')`（不是字符串形式）
- [x] **API库名称**：`torch-gcu`（主库）+ `ptex`（设备操作库）
- [x] **设备检查函数**：使用`ptex.device('xla')`创建设备
- [x] **随机数生成**：`ptex.tops.manual_seed_all(seed)`
- [x] **数据类型支持**：`torch.float16`和`torch.bfloat16`

**适配模式：**
- `'cuda'` → `ptex.device('xla')`
- `torch.cuda.*` → `ptex.tops.*`
- 需要导入：`import ptex`

**多卡训练命令：**
- 使用标准的`torchrun`或`python -m torch.distributed.launch`

#### 2. 执行代码适配
- [ ] **运行适配脚本**
  ```bash
  # 先进行干运行检查
  python scripts/adapt_to_enflame_t20.py --dry_run
  
  # 确认无误后执行实际适配
  python scripts/adapt_to_enflame_t20.py --device_name [设备名] --api_name [API名]
  ```

- [ ] **手动检查关键文件**
  - [ ] `run_staged_distillation_experiment.py`
  - [ ] `run_task_oriented_distillation.py`
  - [ ] `run_improved_distillation_experiment.py`
  - [ ] `configs/train_distill_dinov3_v2_improved.py`
  - [ ] `scripts/validate_tta.py`

#### 3. 准备验证环境
- [ ] **权重文件准备**
  - [ ] 确认`best_mIoU_iter_6000.pth`文件位置
  - [ ] 更新`scripts/validate_tta.py`中的`CHECKPOINT_PATH`
  - 权重文件路径：`___________`

- [ ] **数据集准备**
  - [ ] 确认LoveDA数据集路径
  - [ ] 验证数据集结构完整性
  - 数据集路径：`___________`

#### 4. 执行基准验证
- [ ] **环境测试**
  ```python
  # 在Python中测试设备可用性
  import torch
  print(f"设备可用: {torch.[API名].is_available()}")
  print(f"设备数量: {torch.[API名].device_count()}")
  ```

- [ ] **运行验证脚本**
  ```bash
  # 使用燧原多卡命令运行验证
  [多卡命令] scripts/validate_tta.py
  ```

- [ ] **验证结果检查**
  - [ ] 脚本成功运行，无设备错误
  - [ ] mIoU分数在84.96%左右（±1%）
  - [ ] 显示完整的评估结果
  - 实际mIoU：`___________`

## 🎯 成功标准

### 必须达到的指标
1. **技术指标**
   - mIoU ≥ 84.0%（目标84.96%）
   - 脚本运行无错误
   - 8卡设备正常识别

2. **功能验证**
   - TTA（测试时增强）正常工作
   - 模型加载成功
   - 推理速度合理

### 验证输出示例
```
=== ✍️ 生成 v87 配置 (修正拼写错误) ===
✅ 配置写入: configs/v87/v87_tta_final.py

=== 🚀 启动 v87 TTA评估 (最终修正版) ===
--> 正在手动从 /path/to/best_mIoU_iter_6000.pth 加载权重...
--> 权重加载成功！

============================================================
🎉 v87 TTA评估完成!
最终评估结果: {'aAcc': 0.xxx, 'mIoU': 0.8496, 'mAcc': 0.xxx}
============================================================
```

## 🚨 常见问题及解决方案

### 问题1: 设备不可用
**症状**: `RuntimeError: No [设备名] devices available`
**解决**:
- 检查Docker容器是否正确映射GPU
- 验证燧原驱动安装
- 确认设备名称正确

### 问题2: 权重加载失败
**症状**: `FileNotFoundError` 或 `RuntimeError: Error loading checkpoint`
**解决**:
- 检查权重文件路径
- 验证文件完整性
- 确认模型架构匹配

### 问题3: 内存不足
**症状**: `RuntimeError: out of memory`
**解决**:
- 减少batch_size
- 使用单卡验证
- 清理GPU缓存

### 问题4: mIoU偏低
**症状**: mIoU < 84.0%
**可能原因**:
- 数据预处理不一致
- 模型精度损失
- 设备计算差异

## 📈 下一步准备

### 阶段一准备工作
完成阶段0后，立即开始准备：

1. **数据集准备**
   - [ ] 下载MMRS-1M数据集
   - [ ] 编写数据加载器
   - [ ] 验证数据格式

2. **配置文件创建**
   - [ ] 创建`configs/train_dino_on_mmrs1m.py`
   - [ ] 配置DINOv3骨干网络
   - [ ] 设置大batch_size训练

3. **训练环境验证**
   - [ ] 测试8卡并行训练
   - [ ] 验证训练速度
   - [ ] 配置监控系统

## 📞 技术支持联系

如遇到问题，请联系：
- **燧原技术支持**: [联系方式]
- **项目技术负责人**: [联系方式]
- **紧急联系**: [联系方式]

---

**重要提醒**: 只有完全通过阶段0的验证，才能确保后续阶段的成功。请严格按照清单逐项完成，不要跳过任何步骤。