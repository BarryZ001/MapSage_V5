# 阶段0执行指导：燧原T20适配与基准验证

## 🎯 目标
完成MapSage V5项目在燧原T20集群上的适配，并验证基准性能达到mIoU ≥ 84.96%

## 📋 当前状态
- ✅ **代码库已同步**：项目已推送到GitHub
- ✅ **硬件环境已配置**：T20集群TopsRider软件栈已部署
- ✅ **适配信息已获取**：基于T20环境配置手册确认技术细节
- 🔄 **代码适配进行中**：需要执行自动适配脚本

---

## 🚀 执行步骤

### 步骤1: 准备权重文件

首先准备所需的预训练权重文件，详细步骤请参考 `权重文件准备指导.md`。

关键权重文件：
- `best_mIoU_iter_6000.pth` (主要检查点)
- `iter_8000.pth` (中间检查点)
- `mit-b2_in1k-20230209-4d95315b.pth` (MIT-B2预训练权重)
- `dinov3_vitl16_pretrain_sat493m-eadcf0ff.pth` (DINOv3预训练权重)

### 步骤2：准备工作环境

```bash
# 1. 确保在T20服务器的容器内
docker exec -it t20_mapsage_env /bin/bash

# 2. 进入项目目录
cd /workspace/code  # 项目代码挂载路径

# 3. 确认torch-gcu和ptex可用
python -c "import torch; import ptex; print('环境检查通过')"

# 4. 确认数据集路径
ls -la /workspace/data/loveda
ls -la /workspace/data/mmrs1m
ls -la /workspace/data/EarthVQA

# 5. 确认权重文件
ls -la /workspace/weights/
```

### 步骤3：更新路径配置

首先更新所有配置文件中的路径：

```bash
# 检查需要更新的路径
python scripts/update_paths_for_t20.py --dry-run

# 执行路径更新
python scripts/update_paths_for_t20.py
```

### 步骤4：执行代码适配

```bash
# 1. 首先进行干运行，查看需要修改的文件
python scripts/adapt_to_enflame_t20.py --dry-run \
  scripts/validate_tta.py \
  scripts/run_staged_distillation_experiment.py \
  scripts/run_task_oriented_distillation.py \
  scripts/run_improved_distillation_experiment.py \
  configs/train_distill_dinov3_v2_improved.py

# 2. 确认修改内容无误后，执行实际修改
python scripts/adapt_to_enflame_t20.py \
  scripts/validate_tta.py \
  scripts/run_staged_distillation_experiment.py \
  scripts/run_task_oriented_distillation.py \
  scripts/run_improved_distillation_experiment.py \
  configs/train_distill_dinov3_v2_improved.py
```

### 步骤5：手动检查关键文件

检查以下文件是否正确适配：

#### A. validate_tta.py
```python
# 应该包含：
import ptex
DEVICE = ptex.device('xla')  # 替代原来的 'cuda'
```

#### B. 实验脚本
```python
# 应该包含：
device = ptex.device('xla')
ptex.tops.manual_seed_all(seed)  # 替代 torch.cuda.manual_seed_all
```

### 步骤6：准备验证数据

```bash
# 1. 确保有测试数据集
# 根据validate_tta.py中的配置，准备相应的数据集

# 2. 确保有预训练权重
# 检查权重文件路径是否正确
ls -la /path/to/checkpoint.pth
```

### 步骤7：执行基准验证

```bash
# 运行验证脚本
python scripts/validate_tta.py

# 预期输出：
# - 模型加载成功
# - 数据加载成功
# - 推理过程正常
# - mIoU结果 ≥ 84.96%
```

---

## 🔍 验证检查点

### 适配完成检查
- [ ] 所有CUDA相关代码已替换为ptex.device('xla')
- [ ] torch.cuda.*函数已替换为ptex.tops.*
- [ ] 导入语句包含`import ptex`
- [ ] 没有语法错误或导入错误

### 运行环境检查
- [ ] torch-gcu库可正常导入
- [ ] ptex库可正常导入
- [ ] 设备创建`ptex.device('xla')`成功
- [ ] 数据集路径正确
- [ ] 权重文件路径正确

### 性能验证检查
- [ ] 模型可以正常加载到燧原设备
- [ ] 推理过程无错误
- [ ] **关键指标**：mIoU ≥ 84.96%
- [ ] 内存使用正常
- [ ] 推理速度合理

---

## 🚨 常见问题排查

### 问题1：导入错误
```bash
# 错误：ModuleNotFoundError: No module named 'ptex'
# 解决：重新安装torch-gcu
cd / && ./TopsRider_t2x_2.5.136_deb_amd64.run -y -C torch-gcu
```

### 问题2：设备创建失败
```python
# 错误：ptex.device('xla') 创建失败
# 检查：确认TopsRider驱动正常
lsmod | grep enflame
```

### 问题3：性能不达标
```bash
# 如果mIoU < 84.96%
# 1. 检查权重文件是否正确
# 2. 检查数据预处理是否一致
# 3. 检查模型配置是否正确
```

---

## 📊 成功标准

### 阶段0完成标准
1. **代码适配成功**：所有CUDA代码已适配为燧原T20
2. **环境运行正常**：无导入错误，设备创建成功
3. **基准验证通过**：mIoU ≥ 84.96%
4. **性能稳定**：多次运行结果一致

### 输出文件
- 适配后的Python脚本（备份原文件）
- 验证结果日志
- 性能指标报告

---

## 🎉 完成后的下一步

阶段0成功完成后，即可进入：
- **阶段一**：训练终极基础模型
- **阶段二**：专精化高精度分割

参考文档：`docs/DINOv3版训练计划.md`