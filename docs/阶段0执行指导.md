# é˜¶æ®µ0æ‰§è¡ŒæŒ‡å¯¼ï¼šç‡§åŸT20é€‚é…ä¸åŸºå‡†éªŒè¯

## ğŸ¯ ç›®æ ‡
å®ŒæˆMapSage V5é¡¹ç›®åœ¨ç‡§åŸT20é›†ç¾¤ä¸Šçš„é€‚é…ï¼Œå¹¶éªŒè¯åŸºå‡†æ€§èƒ½è¾¾åˆ°mIoU â‰¥ 84.96%

## ğŸ“‹ å½“å‰çŠ¶æ€
- âœ… **ä»£ç åº“å·²åŒæ­¥**ï¼šé¡¹ç›®å·²æ¨é€åˆ°GitHub
- âœ… **ç¡¬ä»¶ç¯å¢ƒå·²é…ç½®**ï¼šT20é›†ç¾¤TopsRiderè½¯ä»¶æ ˆå·²éƒ¨ç½²
- âœ… **é€‚é…ä¿¡æ¯å·²è·å–**ï¼šåŸºäºT20ç¯å¢ƒé…ç½®æ‰‹å†Œç¡®è®¤æŠ€æœ¯ç»†èŠ‚
- ğŸ”„ **ä»£ç é€‚é…è¿›è¡Œä¸­**ï¼šéœ€è¦æ‰§è¡Œè‡ªåŠ¨é€‚é…è„šæœ¬

---

## ğŸš€ æ‰§è¡Œæ­¥éª¤

### æ­¥éª¤1: å‡†å¤‡æƒé‡æ–‡ä»¶

é¦–å…ˆå‡†å¤‡æ‰€éœ€çš„é¢„è®­ç»ƒæƒé‡æ–‡ä»¶ï¼Œè¯¦ç»†æ­¥éª¤è¯·å‚è€ƒ `æƒé‡æ–‡ä»¶å‡†å¤‡æŒ‡å¯¼.md`ã€‚

å…³é”®æƒé‡æ–‡ä»¶ï¼š
- `best_mIoU_iter_6000.pth` (ä¸»è¦æ£€æŸ¥ç‚¹)
- `iter_8000.pth` (ä¸­é—´æ£€æŸ¥ç‚¹)
- `mit-b2_in1k-20230209-4d95315b.pth` (MIT-B2é¢„è®­ç»ƒæƒé‡)
- `dinov3_vitl16_pretrain_sat493m-eadcf0ff.pth` (DINOv3é¢„è®­ç»ƒæƒé‡)

### æ­¥éª¤2ï¼šå‡†å¤‡å·¥ä½œç¯å¢ƒ

```bash
# 1. ç¡®ä¿åœ¨T20æœåŠ¡å™¨çš„å®¹å™¨å†…
docker exec -it t20_mapsage_env /bin/bash

# 2. è¿›å…¥é¡¹ç›®ç›®å½•
cd /workspace/code  # é¡¹ç›®ä»£ç æŒ‚è½½è·¯å¾„

# 3. ç¡®è®¤torch-gcuå’Œptexå¯ç”¨
python -c "import torch; import ptex; print('ç¯å¢ƒæ£€æŸ¥é€šè¿‡')"

# 4. ç¡®è®¤æ•°æ®é›†è·¯å¾„
ls -la /workspace/data/loveda
ls -la /workspace/data/mmrs1m
ls -la /workspace/data/EarthVQA

# 5. ç¡®è®¤æƒé‡æ–‡ä»¶
ls -la /workspace/weights/
```

### æ­¥éª¤3ï¼šæ›´æ–°è·¯å¾„é…ç½®

é¦–å…ˆæ›´æ–°æ‰€æœ‰é…ç½®æ–‡ä»¶ä¸­çš„è·¯å¾„ï¼š

```bash
# æ£€æŸ¥éœ€è¦æ›´æ–°çš„è·¯å¾„
python scripts/update_paths_for_t20.py --dry-run

# æ‰§è¡Œè·¯å¾„æ›´æ–°
python scripts/update_paths_for_t20.py
```

### æ­¥éª¤4ï¼šæ‰§è¡Œä»£ç é€‚é…

```bash
# 1. é¦–å…ˆè¿›è¡Œå¹²è¿è¡Œï¼ŒæŸ¥çœ‹éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶
python scripts/adapt_to_enflame_t20.py --dry-run \
  scripts/validate_tta.py \
  scripts/run_staged_distillation_experiment.py \
  scripts/run_task_oriented_distillation.py \
  scripts/run_improved_distillation_experiment.py \
  configs/train_distill_dinov3_v2_improved.py

# 2. ç¡®è®¤ä¿®æ”¹å†…å®¹æ— è¯¯åï¼Œæ‰§è¡Œå®é™…ä¿®æ”¹
python scripts/adapt_to_enflame_t20.py \
  scripts/validate_tta.py \
  scripts/run_staged_distillation_experiment.py \
  scripts/run_task_oriented_distillation.py \
  scripts/run_improved_distillation_experiment.py \
  configs/train_distill_dinov3_v2_improved.py
```

### æ­¥éª¤5ï¼šæ‰‹åŠ¨æ£€æŸ¥å…³é”®æ–‡ä»¶

æ£€æŸ¥ä»¥ä¸‹æ–‡ä»¶æ˜¯å¦æ­£ç¡®é€‚é…ï¼š

#### A. validate_tta.py
```python
# åº”è¯¥åŒ…å«ï¼š
import ptex
DEVICE = ptex.device('xla')  # æ›¿ä»£åŸæ¥çš„ 'cuda'
```

#### B. å®éªŒè„šæœ¬
```python
# åº”è¯¥åŒ…å«ï¼š
device = ptex.device('xla')
ptex.tops.manual_seed_all(seed)  # æ›¿ä»£ torch.cuda.manual_seed_all
```

### æ­¥éª¤6ï¼šå‡†å¤‡éªŒè¯æ•°æ®

```bash
# 1. ç¡®ä¿æœ‰æµ‹è¯•æ•°æ®é›†
# æ ¹æ®validate_tta.pyä¸­çš„é…ç½®ï¼Œå‡†å¤‡ç›¸åº”çš„æ•°æ®é›†

# 2. ç¡®ä¿æœ‰é¢„è®­ç»ƒæƒé‡
# æ£€æŸ¥æƒé‡æ–‡ä»¶è·¯å¾„æ˜¯å¦æ­£ç¡®
ls -la /path/to/checkpoint.pth
```

### æ­¥éª¤7ï¼šæ‰§è¡ŒåŸºå‡†éªŒè¯

```bash
# è¿è¡ŒéªŒè¯è„šæœ¬
python scripts/validate_tta.py

# é¢„æœŸè¾“å‡ºï¼š
# - æ¨¡å‹åŠ è½½æˆåŠŸ
# - æ•°æ®åŠ è½½æˆåŠŸ
# - æ¨ç†è¿‡ç¨‹æ­£å¸¸
# - mIoUç»“æœ â‰¥ 84.96%
```

---

## ğŸ” éªŒè¯æ£€æŸ¥ç‚¹

### é€‚é…å®Œæˆæ£€æŸ¥
- [ ] æ‰€æœ‰CUDAç›¸å…³ä»£ç å·²æ›¿æ¢ä¸ºptex.device('xla')
- [ ] torch.cuda.*å‡½æ•°å·²æ›¿æ¢ä¸ºptex.tops.*
- [ ] å¯¼å…¥è¯­å¥åŒ…å«`import ptex`
- [ ] æ²¡æœ‰è¯­æ³•é”™è¯¯æˆ–å¯¼å…¥é”™è¯¯

### è¿è¡Œç¯å¢ƒæ£€æŸ¥
- [ ] torch-gcuåº“å¯æ­£å¸¸å¯¼å…¥
- [ ] ptexåº“å¯æ­£å¸¸å¯¼å…¥
- [ ] è®¾å¤‡åˆ›å»º`ptex.device('xla')`æˆåŠŸ
- [ ] æ•°æ®é›†è·¯å¾„æ­£ç¡®
- [ ] æƒé‡æ–‡ä»¶è·¯å¾„æ­£ç¡®

### æ€§èƒ½éªŒè¯æ£€æŸ¥
- [ ] æ¨¡å‹å¯ä»¥æ­£å¸¸åŠ è½½åˆ°ç‡§åŸè®¾å¤‡
- [ ] æ¨ç†è¿‡ç¨‹æ— é”™è¯¯
- [ ] **å…³é”®æŒ‡æ ‡**ï¼šmIoU â‰¥ 84.96%
- [ ] å†…å­˜ä½¿ç”¨æ­£å¸¸
- [ ] æ¨ç†é€Ÿåº¦åˆç†

---

## ğŸš¨ å¸¸è§é—®é¢˜æ’æŸ¥

### é—®é¢˜1ï¼šå¯¼å…¥é”™è¯¯
```bash
# é”™è¯¯ï¼šModuleNotFoundError: No module named 'ptex'
# è§£å†³ï¼šé‡æ–°å®‰è£…torch-gcu
cd / && ./TopsRider_t2x_2.5.136_deb_amd64.run -y -C torch-gcu
```

### é—®é¢˜2ï¼šè®¾å¤‡åˆ›å»ºå¤±è´¥
```python
# é”™è¯¯ï¼šptex.device('xla') åˆ›å»ºå¤±è´¥
# æ£€æŸ¥ï¼šç¡®è®¤TopsRideré©±åŠ¨æ­£å¸¸
lsmod | grep enflame
```

### é—®é¢˜3ï¼šæ€§èƒ½ä¸è¾¾æ ‡
```bash
# å¦‚æœmIoU < 84.96%
# 1. æ£€æŸ¥æƒé‡æ–‡ä»¶æ˜¯å¦æ­£ç¡®
# 2. æ£€æŸ¥æ•°æ®é¢„å¤„ç†æ˜¯å¦ä¸€è‡´
# 3. æ£€æŸ¥æ¨¡å‹é…ç½®æ˜¯å¦æ­£ç¡®
```

---

## ğŸ“Š æˆåŠŸæ ‡å‡†

### é˜¶æ®µ0å®Œæˆæ ‡å‡†
1. **ä»£ç é€‚é…æˆåŠŸ**ï¼šæ‰€æœ‰CUDAä»£ç å·²é€‚é…ä¸ºç‡§åŸT20
2. **ç¯å¢ƒè¿è¡Œæ­£å¸¸**ï¼šæ— å¯¼å…¥é”™è¯¯ï¼Œè®¾å¤‡åˆ›å»ºæˆåŠŸ
3. **åŸºå‡†éªŒè¯é€šè¿‡**ï¼šmIoU â‰¥ 84.96%
4. **æ€§èƒ½ç¨³å®š**ï¼šå¤šæ¬¡è¿è¡Œç»“æœä¸€è‡´

### è¾“å‡ºæ–‡ä»¶
- é€‚é…åçš„Pythonè„šæœ¬ï¼ˆå¤‡ä»½åŸæ–‡ä»¶ï¼‰
- éªŒè¯ç»“æœæ—¥å¿—
- æ€§èƒ½æŒ‡æ ‡æŠ¥å‘Š

---

## ğŸ‰ å®Œæˆåçš„ä¸‹ä¸€æ­¥

é˜¶æ®µ0æˆåŠŸå®Œæˆåï¼Œå³å¯è¿›å…¥ï¼š
- **é˜¶æ®µä¸€**ï¼šè®­ç»ƒç»ˆæåŸºç¡€æ¨¡å‹
- **é˜¶æ®µäºŒ**ï¼šä¸“ç²¾åŒ–é«˜ç²¾åº¦åˆ†å‰²

å‚è€ƒæ–‡æ¡£ï¼š`docs/DINOv3ç‰ˆè®­ç»ƒè®¡åˆ’.md`