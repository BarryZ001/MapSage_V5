# 权重文件准备指导

## 概述

本文档说明如何准备MapSage项目所需的预训练权重文件，以便在T20服务器上正常运行。

## 权重文件清单

根据配置文件分析，项目需要以下权重文件：

### 1. 主要检查点文件
- **文件名**: `best_mIoU_iter_6000.pth`
- **用途**: Stage2基线模型检查点 (mIoU=84.96)
- **目标路径**: `/workspace/weights/best_mIoU_iter_6000.pth`
- **原始路径**: `/kaggle/input/mapsage-stage02-checkpoint-6000/best_mIoU_iter_6000.pth`

### 2. 中间训练检查点
- **文件名**: `iter_8000.pth`
- **用途**: 8000轮训练检查点
- **目标路径**: `/workspace/weights/iter_8000.pth`
- **原始路径**: `/kaggle/input/temp-8000tier/iter_8000.pth`

### 3. 预训练骨干网络权重

#### MIT-B2 ImageNet权重
- **文件名**: `mit-b2_in1k-20230209-4d95315b.pth`
- **用途**: MIT-B2骨干网络ImageNet预训练权重
- **目标路径**: `/workspace/weights/mit-b2_in1k-20230209-4d95315b.pth`
- **下载链接**: [MMSegmentation官方](https://download.openmmlab.com/mmsegmentation/v0.5/pretrain/segformer/mit_b2_20220624-66e8bf70.pth)

#### DINOv3 ViT-L/16权重
- **文件名**: `dinov3_vitl16_pretrain_sat493m-eadcf0ff.pth`
- **用途**: DINOv3 ViT-Large/16遥感预训练权重
- **目标路径**: `/workspace/weights/dinov3_vitl16_pretrain_sat493m-eadcf0ff.pth`
- **说明**: 这是在493M遥感图像上预训练的DINOv3模型

## 权重文件获取方式

### 方式1: 从Kaggle数据集下载

如果你有Kaggle账号和相关数据集访问权限：

```bash
# 安装Kaggle API
pip install kaggle

# 配置API密钥 (需要从Kaggle账户设置中获取)
mkdir -p ~/.kaggle
echo '{"username":"your_username","key":"your_key"}' > ~/.kaggle/kaggle.json
chmod 600 ~/.kaggle/kaggle.json

# 下载数据集 (示例)
kaggle datasets download -d your-dataset/mapsage-stage02-checkpoint-6000
```

### 方式2: 从官方源下载

对于公开可用的预训练权重：

```bash
# MIT-B2权重
wget https://download.openmmlab.com/mmsegmentation/v0.5/pretrain/segformer/mit_b2_20220624-66e8bf70.pth \
     -O /workspace/weights/mit-b2_in1k-20230209-4d95315b.pth

# 其他权重需要根据具体来源获取
```

### 方式3: 从本地上传

如果你已经有权重文件：

```bash
# 使用scp上传到服务器
scp local_weights/* user@server:/root/mapsage_project/weights/

# 或在服务器上直接放置到挂载目录
cp your_weights/* /root/mapsage_project/weights/
```

## 服务器端权重目录准备

在T20服务器上创建权重目录：

```bash
# 创建权重目录
sudo mkdir -p /root/mapsage_project/weights

# 设置权限
sudo chmod 755 /root/mapsage_project/weights

# 检查挂载
ls -la /root/mapsage_project/weights
```

## 容器内验证

启动容器后验证权重文件：

```bash
# 进入容器
docker exec -it t20_mapsage_env bash

# 检查权重目录
ls -la /workspace/weights/

# 验证文件完整性
file /workspace/weights/*.pth
du -h /workspace/weights/*.pth
```

## 权重文件大小参考

- `best_mIoU_iter_6000.pth`: ~200-500MB
- `iter_8000.pth`: ~200-500MB  
- `mit-b2_in1k-20230209-4d95315b.pth`: ~25-50MB
- `dinov3_vitl16_pretrain_sat493m-eadcf0ff.pth`: ~1-2GB

## 常见问题

### Q: 权重文件下载失败
A: 检查网络连接，尝试使用代理或镜像源

### Q: 容器内看不到权重文件
A: 检查Docker挂载配置，确保`-v /root/mapsage_project/weights:/workspace/weights`正确

### Q: 权重文件损坏
A: 重新下载，验证文件哈希值

### Q: 磁盘空间不足
A: 清理不必要的文件，或扩展存储空间

## 验证检查点

完成权重准备后，运行以下检查：

```bash
# 检查所有必需权重文件
required_weights=(
    "best_mIoU_iter_6000.pth"
    "iter_8000.pth"
    "mit-b2_in1k-20230209-4d95315b.pth"
    "dinov3_vitl16_pretrain_sat493m-eadcf0ff.pth"
)

for weight in "${required_weights[@]}"; do
    if [ -f "/workspace/weights/$weight" ]; then
        echo "✅ $weight 存在"
    else
        echo "❌ $weight 缺失"
    fi
done
```

## 下一步

权重文件准备完成后，可以继续执行：
1. 路径配置更新
2. 代码适配
3. 基准验证

参考 `阶段0执行指导.md` 继续后续步骤。