# 燧原T20集群适配指导

## 当前进度
您已完成：
- ✅ 将GitHub代码库克隆到新服务器的Docker容器中
- 🔄 正在配置服务端

## 接下来需要完成的步骤

### 1. 关键适配信息（已确认）

**✅ 已从T20集群环境配置手册获取关键信息**：

#### A. 设备标识符
- 燧原设备标识符：`ptex.device("xla")`
- 不是传统的字符串形式，而是通过ptex库的device函数

#### B. PyTorch扩展库
- 主要库：`torch-gcu`（通过TopsRider安装）
- 设备操作库：`ptex`
- 随机数生成：`ptex.tops.manual_seed_all()`

#### C. 设备检查和操作
- 设备创建：`ptex.device("xla")`
- 随机种子：`ptex.tops.manual_seed_all(seed)`
- 数据类型：支持`torch.float16`和`torch.bfloat16`

#### D. 适配模式
- CUDA → GCU：将`'cuda'`替换为`ptex.device('xla')`
- torch.cuda → ptex.tops：CUDA相关函数替换为ptex.tops对应函数

### 2. 代码适配清单

根据我们的代码分析，需要修改以下文件中的CUDA相关代码：

#### 核心实验脚本
1. **run_staged_distillation_experiment.py** (第247行)
   ```python
   # 修改前
   self.device = torch.device('cuda' if torch.cuda.is_available() else 'cpu')
   
   # 修改后 (假设设备名为 'gcu')
   self.device = torch.device('gcu' if torch.gcu.is_available() else 'cpu')
   ```

2. **run_task_oriented_distillation.py** (第273行)
   ```python
   # 修改前
   self.device = torch.device('cuda' if torch.cuda.is_available() else 'cpu')
   
   # 修改后
   self.device = torch.device('gcu' if torch.gcu.is_available() else 'cpu')
   ```

3. **run_improved_distillation_experiment.py** (第52行)
   ```python
   # 修改前
   self.device = 'cuda' if torch.cuda.is_available() else 'cpu'
   
   # 修改后
   self.device = 'gcu' if torch.gcu.is_available() else 'cpu'
   ```

#### 配置文件
4. **configs/train_distill_dinov3_v2_improved.py** (第391行)
   ```python
   # 修改前
   'device': 'cuda' if torch.cuda.is_available() else 'cpu'
   
   # 修改后
   'device': 'gcu' if torch.gcu.is_available() else 'cpu'
   ```

#### 辅助脚本
5. **scripts/setup_distillation_environment.py** (第107-108行)
   ```python
   # 修改前
   if torch.cuda.is_available():
       print(f"✅ CUDA available: {torch.cuda.get_device_name(0)}")
   
   # 修改后
   if torch.gcu.is_available():
       print(f"✅ GCU available: {torch.gcu.get_device_name(0)}")
   ```

### 3. 验证基准的具体步骤

完成代码适配后，按以下步骤验证：

#### A. 准备验证环境
```bash
# 在Docker容器中
cd /path/to/MapSage_V5

# 确保权重文件路径正确
# 将 best_mIoU_iter_6000.pth 放置到正确位置
```

#### B. 修改validate_tta.py中的路径
```python
# 修改 scripts/validate_tta.py 第19行
CHECKPOINT_PATH = '/your/actual/path/to/best_mIoU_iter_6000.pth'
```

#### C. 运行验证命令
```bash
# 使用燧原的多卡训练命令（具体命令需要确认）
# 示例（实际命令可能不同）：
torchrun --nproc_per_node=8 scripts/validate_tta.py

# 或者单卡验证：
python scripts/validate_tta.py
```

#### D. 成功标准
- ✅ 脚本成功运行，无设备相关错误
- ✅ mIoU分数在 **84.96%左右**
- ✅ 显示类似输出：
  ```
  🎉 v87 TTA评估完成!
  最终评估结果: {'aAcc': 0.xxx, 'mIoU': 0.8496, 'mAcc': 0.xxx}
  ```

### 4. 常见问题排查

#### 问题1：设备不可用
```python
# 检查设备状态
import torch
print(f"设备可用性: {torch.gcu.is_available()}")
print(f"设备数量: {torch.gcu.device_count()}")
```

#### 问题2：权重加载失败
- 检查权重文件路径是否正确
- 确认权重文件完整性
- 验证模型架构匹配

#### 问题3：内存不足
- 减少batch_size
- 使用梯度累积
- 启用混合精度训练

### 5. 下一步准备

完成验证后，您就可以进入 **阶段一：训练终极基础模型**：
- 准备MMRS-1M数据集
- 创建DINOv3训练配置
- 启动大规模训练

## 需要确认的信息

请向燧原技术支持确认：
1. **设备名称**：替代'cuda'的具体字符串
2. **API接口**：torch.gcu 还是其他接口名称
3. **多卡命令**：8卡并行训练的启动命令
4. **环境变量**：是否需要设置特殊的环境变量

确认这些信息后，我们就可以开始具体的代码适配工作。