# T20环境问题修复指南

## 问题描述

根据环境验证脚本的输出，T20环境存在以下问题：

```
❌ torch-gcu框架不可用
❌ ptex模块未安装
❌ XLA设备检查错误: No module named 'torch_gcu'
```

## 解决方案

### 步骤1：登录T20服务器并进入容器

```bash
# 在本地机器上登录T20服务器
ssh root@a202-f05-xl-t20-03

# 查看运行中的容器
docker ps

# 进入t20_mapsage_env容器
docker exec -it t20_mapsage_env /bin/bash

# 进入工作目录
cd /workspace/code/MapSage_V5

# 确认当前在容器内（应该能看到/usr/local/topsrider目录）
ls /usr/local/topsrider
```

### 步骤2：拷贝TopsRider安装文件到容器（如果需要）

如果容器内没有TopsRider安装文件，需要从主机拷贝：

```bash
# 在主机上（容器外）执行，将TopsRider安装文件拷贝到容器挂载目录
# 假设主机上的安装文件在/root目录
cp /root/TopsRider_t2x_2.5.136_deb_amd64.run /root/mapsage_project/code/

# 或者直接拷贝到容器内的/root目录
docker cp /root/TopsRider_t2x_2.5.136_deb_amd64.run t20_mapsage_env:/root/
```

### 步骤3：运行环境修复脚本

```bash
# 在T20服务器容器内执行修复脚本
bash scripts/fix_t20_environment.sh
```

### 步骤4：手动修复（如果自动修复失败）

#### 4.1 重新安装torch-gcu框架

如果torch-gcu框架不可用，需要重新安装：

```bash
# 在容器内查找TopsRider安装程序（优先查找/root目录）
find /root -name "TopsRider*.run" -type f

# 如果/root目录没有，再查找/usr/local/topsrider目录
find /usr/local/topsrider -name "TopsRider*.run" -type f

# 使用找到的安装程序按照官方手册分两步重新安装torch-gcu
# 例如：
chmod +x /root/TopsRider_t2x_2.5.136_deb_amd64.run

# 第一步：安装基础软件栈
/root/TopsRider_t2x_2.5.136_deb_amd64.run -y

# 第二步：安装torch-gcu框架
/root/TopsRider_t2x_2.5.136_deb_amd64.run -y -C torch-gcu

# 验证安装
python3 -c "import torch; print('PyTorch version:', torch.__version__); print('torch.gcu available:', hasattr(torch, 'gcu'))"
```

#### 4.2 设置环境变量

安装完成后需要设置环境变量：

```bash
# 设置当前会话的环境变量
export PATH="/opt/tops/bin:$PATH"
export LD_LIBRARY_PATH="/opt/tops/lib:$LD_LIBRARY_PATH"

# 添加到bashrc以持久化
echo 'export PATH="/opt/tops/bin:$PATH"' >> ~/.bashrc
echo 'export LD_LIBRARY_PATH="/opt/tops/lib:$LD_LIBRARY_PATH"' >> ~/.bashrc

# 重新加载环境
source ~/.bashrc
```

#### 4.3 重启容器（如果需要）

如果环境变量设置后torch-gcu仍不可用，可能需要重启容器：

```bash
# 退出容器
exit

# 重新进入容器
docker exec -it t20_mapsage_env /bin/bash

# 进入项目目录
cd /workspace/code/MapSage_V5
```

#### 4.4 安装ptex模块

```bash
# 查找ptex wheel包
find /usr/local/topsrider -name "ptex*.whl" -type f

# 安装ptex模块（使用找到的实际路径）
pip3 install /usr/local/topsrider/ai_development_toolkit/pytorch-gcu/ptex-2.1.0+torch1.11.0-py3-none-any.whl

# 验证ptex安装
python3 -c "import ptex; print('ptex模块导入成功'); print('XLA devices:', ptex.device_count())"
```

#### 4.5 测试ptex功能

```bash
# 完整功能测试
python3 -c "
import ptex
import torch

print('ptex模块导入成功')
print('XLA device count:', ptex.device_count())

# 测试设备创建和张量操作
device = ptex.device('xla')
print('XLA device:', device)

x = torch.randn(2, 3).to(device)
y = torch.randn(2, 3).to(device)
z = x + y
print('Tensor operation successful:', z.shape)
print('Result on device:', z.device)
"
```

### 步骤5：验证修复结果

```bash
# 运行环境验证脚本
python3 scripts/validate_training_env.py
```

期望看到的正确输出：

```
✅ torch-gcu框架可用
✅ ptex模块已安装
🖥️  XLA设备信息:
   ✅ XLA设备数量: X
   ✅ 设备类型: GCU
```

## 常见问题排查

### 问题1：找不到ptex wheel包

**症状**：`find /usr/local/topsrider -name "ptex*.whl"` 没有输出

**解决方案**：
1. 检查TopsRider软件栈是否完整安装
2. 重新运行TopsRider安装程序
3. 联系系统管理员确认安装状态

### 问题2：torch-gcu框架安装失败

**症状**：`hasattr(torch, 'gcu')` 返回 `False`

**解决方案**：
1. 确认在正确的容器环境中
2. 检查TopsRider安装程序是否存在
3. 重新运行完整的TopsRider安装

### 问题3：ptex模块导入失败

**症状**：`ModuleNotFoundError: No module named 'ptex'`

**解决方案**：
1. 确认wheel包路径正确
2. 使用 `--force-reinstall` 参数重新安装
3. 检查Python环境和权限设置

### 问题4：XLA设备访问失败

**症状**：`ptex.device_count()` 返回0或报错

**解决方案**：
1. 检查GCU硬件状态
2. 重启容器或服务
3. 联系系统管理员检查硬件配置

## 修复完成后的下一步

环境修复完成后，可以开始训练：

```bash
# 启动DINOv3 + MMRS-1M训练
bash scripts/train_dinov3_mmrs1m.sh
```

## 技术支持

如果遇到无法解决的问题，请：

1. 保存完整的错误日志
2. 记录执行的具体步骤
3. 提供系统环境信息
4. 联系技术支持团队

---

**注意事项**：
- 所有修复操作必须在T20服务器的容器内执行
- 确保有足够的权限执行安装操作
- 修复过程中请勿中断，避免环境损坏
- 建议在修复前备份重要数据和配置