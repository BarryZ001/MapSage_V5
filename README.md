# MapSage V4 é¥æ„Ÿåˆ†å‰²æ¨¡å‹éªŒè¯åº”ç”¨

ğŸ›°ï¸ åŸºäºStreamlitçš„é¥æ„Ÿå½±åƒåˆ†å‰²æ¨¡å‹æ•ˆæœéªŒè¯å·¥å…·

## ğŸ“Š é¡¹ç›®æ¦‚è¿°

æœ¬åº”ç”¨ç”¨äºåœ¨Mac Intel CPUç¯å¢ƒä¸‹éªŒè¯MapSage V4é¥æ„Ÿåˆ†å‰²æ¨¡å‹çš„æ•ˆæœã€‚æ¨¡å‹åœ¨LoveDAæ•°æ®é›†ä¸Šè®­ç»ƒï¼Œé€šè¿‡æ»‘çª—æ¨ç†å’ŒTTAæŠ€æœ¯è¾¾åˆ°äº†**mIoU = 84.96**çš„ä¼˜ç§€æ€§èƒ½ã€‚

### ğŸ¯ ä¸»è¦åŠŸèƒ½
- ğŸ–¼ï¸ æ”¯æŒå¤šç§æ ¼å¼çš„é¥æ„Ÿå½±åƒä¸Šä¼ 
- ğŸ” å®æ—¶åˆ†å‰²ç»“æœå¯è§†åŒ–
- ğŸ“ˆ è¯¦ç»†çš„ç±»åˆ«ç»Ÿè®¡åˆ†æ
- ğŸ’¾ åˆ†å‰²ç»“æœä¸‹è½½åŠŸèƒ½
- ğŸ¨ ç›´è§‚çš„ç±»åˆ«å›¾ä¾‹æ˜¾ç¤º

### ğŸ·ï¸ æ”¯æŒçš„åœ°ç‰©ç±»åˆ«
1. **èƒŒæ™¯** - ç™½è‰²
2. **å»ºç­‘** - çº¢è‰²
3. **é“è·¯** - é»„è‰²
4. **æ°´ä½“** - è“è‰²
5. **è´«ç˜ åœŸåœ°** - ç´«è‰²
6. **æ£®æ—** - ç»¿è‰²
7. **å†œä¸š** - æ©™è‰²

## ğŸ“ é¡¹ç›®ç»“æ„

```
MapSage_V5/
â”œâ”€â”€ app.py                              # Streamlitä¸»åº”ç”¨
â”œâ”€â”€ requirements.txt                     # Pythonä¾èµ–åŒ…
â”œâ”€â”€ README.md                           # ä½¿ç”¨è¯´æ˜
â”œâ”€â”€ checkpoints/                        # æ¨¡å‹æƒé‡ç›®å½•
â”‚   â””â”€â”€ best_mIoU_iter_6000.pth        # æ‚¨çš„æ¨¡å‹æƒé‡æ–‡ä»¶
â”œâ”€â”€ configs/                            # é…ç½®æ–‡ä»¶ç›®å½•
â”‚   â””â”€â”€ mapsage_v4_eval_config.py      # æ¨¡å‹é…ç½®æ–‡ä»¶
â””â”€â”€ images/                             # æµ‹è¯•å›¾ç‰‡ç›®å½•
    â””â”€â”€ sample_image.png                # ç¤ºä¾‹æµ‹è¯•å›¾ç‰‡
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### æ­¥éª¤1: ç¯å¢ƒå‡†å¤‡

#### 1.1 åˆ›å»ºè™šæ‹Ÿç¯å¢ƒï¼ˆæ¨èï¼‰
```bash
# è¿›å…¥é¡¹ç›®ç›®å½•
cd /Users/barryzhang/myDev3/MapSage_V5

# åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
python3 -m venv .venv

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
source .venv/bin/activate
```

#### 1.2 å®‰è£…ä¾èµ–åŒ…
```bash
# å‡çº§pip
pip install --upgrade pip

# å®‰è£…åŸºç¡€ä¾èµ–
pip install -r requirements.txt

# å®‰è£…MMSegmentationç›¸å…³åŒ…
pip install -U openmim
mim install mmengine
mim install "mmcv>=2.0.0"
pip install "mmsegmentation>=1.0.0"
```

### æ­¥éª¤2: å‡†å¤‡æ¨¡å‹æ–‡ä»¶

#### 2.1 æ¨¡å‹æƒé‡æ–‡ä»¶
å°†æ‚¨çš„æ¨¡å‹æƒé‡æ–‡ä»¶é‡å‘½åä¸º `best_mIoU_iter_6000.pth` å¹¶æ”¾å…¥ `checkpoints/` ç›®å½•ï¼š
```bash
# ç¤ºä¾‹ï¼šå¦‚æœæ‚¨çš„æƒé‡æ–‡ä»¶åä¸º your_model.pth
cp your_model.pth checkpoints/best_mIoU_iter_6000.pth
```

#### 2.2 é…ç½®æ–‡ä»¶
å°†æ‚¨çš„æ¨¡å‹é…ç½®æ–‡ä»¶é‡å‘½åä¸º `mapsage_v4_eval_config.py` å¹¶æ”¾å…¥ `configs/` ç›®å½•ï¼š
```bash
# ç¤ºä¾‹ï¼šå¦‚æœæ‚¨çš„é…ç½®æ–‡ä»¶åä¸º your_config.py
cp your_config.py configs/mapsage_v4_eval_config.py
```

**é‡è¦**: ç¡®ä¿é…ç½®æ–‡ä»¶ä¸­åŒ…å«æ»‘çª—æ¨ç†è®¾ç½®ï¼š
```python
# åœ¨é…ç½®æ–‡ä»¶ä¸­ç¡®ä¿æœ‰ç±»ä¼¼è®¾ç½®
test_cfg = dict(
    mode='slide',
    crop_size=(1024, 1024),
    stride=(768, 768)
)
```

#### 2.3 æµ‹è¯•å›¾ç‰‡ï¼ˆå¯é€‰ï¼‰
å°†ä¸€äº›é¥æ„Ÿå½±åƒæ”¾å…¥ `images/` ç›®å½•ç”¨äºå¿«é€Ÿæµ‹è¯•ï¼š
```bash
# å»ºè®®ä½¿ç”¨æ¥è‡ªLoveDAéªŒè¯é›†çš„å›¾ç‰‡
cp your_test_image.png images/
```

### æ­¥éª¤3: è¿è¡Œåº”ç”¨

```bash
# ç¡®ä¿è™šæ‹Ÿç¯å¢ƒå·²æ¿€æ´»
source .venv/bin/activate

# å¯åŠ¨Streamlitåº”ç”¨
streamlit run app.py
```

åº”ç”¨å°†åœ¨æµè§ˆå™¨ä¸­è‡ªåŠ¨æ‰“å¼€ï¼Œé€šå¸¸åœ°å€ä¸º: `http://localhost:8501`

## ğŸ–¥ï¸ ä½¿ç”¨æŒ‡å—

### åŸºæœ¬æ“ä½œ
1. **ä¸Šä¼ å›¾ç‰‡**: ç‚¹å‡»"é€‰æ‹©ä¸€å¼ å›¾ç‰‡è¿›è¡Œåˆ†å‰²..."æŒ‰é’®ä¸Šä¼ é¥æ„Ÿå½±åƒ
2. **ç­‰å¾…å¤„ç†**: CPUæ¨ç†éœ€è¦1-3åˆ†é’Ÿï¼Œè¯·è€å¿ƒç­‰å¾…
3. **æŸ¥çœ‹ç»“æœ**: åˆ†å‰²ç»“æœå°†æ˜¾ç¤ºåœ¨å³ä¾§é¢æ¿
4. **åˆ†æç»Ÿè®¡**: æŸ¥çœ‹å„ç±»åˆ«çš„åƒç´ ç»Ÿè®¡ä¿¡æ¯
5. **ä¸‹è½½ç»“æœ**: ç‚¹å‡»"ä¸‹è½½åˆ†å‰²ç»“æœ"ä¿å­˜å½©è‰²åˆ†å‰²å›¾

### æ”¯æŒçš„å›¾ç‰‡æ ¼å¼
- JPG / JPEG
- PNG
- TIF / TIFF

### æ¨èå›¾ç‰‡å°ºå¯¸
- **æœ€ä½³**: 512x512 åˆ° 1024x1024 åƒç´ 
- **æœ€å¤§**: ä¸è¶…è¿‡ 2048x2048 åƒç´ 
- **æ³¨æ„**: å›¾ç‰‡è¶Šå¤§ï¼Œå¤„ç†æ—¶é—´è¶Šé•¿

## âš¡ æ€§èƒ½è¯´æ˜

### ç³»ç»Ÿè¦æ±‚
- **æ“ä½œç³»ç»Ÿ**: macOS (IntelèŠ¯ç‰‡)
- **å†…å­˜**: å»ºè®®16GBä»¥ä¸Š
- **å­˜å‚¨**: è‡³å°‘2GBå¯ç”¨ç©ºé—´
- **Python**: 3.8 - 3.11

### æ€§èƒ½æŒ‡æ ‡
- **æ¨ç†æ—¶é—´**: 1-3åˆ†é’Ÿï¼ˆå–å†³äºå›¾ç‰‡å¤§å°ï¼‰
- **å†…å­˜å ç”¨**: 2-4GBï¼ˆåŠ è½½æ¨¡å‹åï¼‰
- **æ¨¡å‹ç²¾åº¦**: mIoU = 84.96
- **æ¨ç†è®¾å¤‡**: CPU only

### æ€§èƒ½ä¼˜åŒ–å»ºè®®
1. **å›¾ç‰‡é¢„å¤„ç†**: å°†å¤§å›¾è£å‰ªä¸º1024x1024ä»¥ä¸‹
2. **å…³é—­å…¶ä»–åº”ç”¨**: é‡Šæ”¾æ›´å¤šå†…å­˜ç»™æ¨ç†è¿‡ç¨‹
3. **ä½¿ç”¨SSD**: ç¡®ä¿é¡¹ç›®åœ¨SSDä¸Šè¿è¡Œ
4. **è™šæ‹Ÿç¯å¢ƒ**: ä½¿ç”¨ç‹¬ç«‹çš„Pythonç¯å¢ƒé¿å…å†²çª

## ğŸ”§ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

#### 1. MMSegmentationå¯¼å…¥å¤±è´¥
```bash
# é‡æ–°å®‰è£…MMSegmentation
pip uninstall mmsegmentation mmcv mmengine
mim install mmengine
mim install "mmcv>=2.0.0"
pip install "mmsegmentation>=1.0.0"
```

#### 2. æ¨¡å‹åŠ è½½å¤±è´¥
- æ£€æŸ¥æƒé‡æ–‡ä»¶è·¯å¾„æ˜¯å¦æ­£ç¡®
- ç¡®è®¤é…ç½®æ–‡ä»¶ä¸æƒé‡æ–‡ä»¶åŒ¹é…
- æŸ¥çœ‹ç»ˆç«¯é”™è¯¯ä¿¡æ¯

#### 3. æ¨ç†é€Ÿåº¦è¿‡æ…¢
- å‡å°è¾“å…¥å›¾ç‰‡å°ºå¯¸
- æ£€æŸ¥ç³»ç»Ÿå†…å­˜ä½¿ç”¨æƒ…å†µ
- ç¡®ä¿æ²¡æœ‰å…¶ä»–å ç”¨CPUçš„ç¨‹åº

#### 4. å†…å­˜ä¸è¶³
```bash
# æ£€æŸ¥å†…å­˜ä½¿ç”¨
top -o MEM

# å¦‚æœå†…å­˜ä¸è¶³ï¼Œå°è¯•å‡å°batch sizeæˆ–å›¾ç‰‡å°ºå¯¸
```

### è°ƒè¯•æ¨¡å¼
å¦‚æœé‡åˆ°é—®é¢˜ï¼Œå¯ä»¥åœ¨ç»ˆç«¯ä¸­æŸ¥çœ‹è¯¦ç»†æ—¥å¿—ï¼š
```bash
# å¯ç”¨è¯¦ç»†æ—¥å¿—
streamlit run app.py --logger.level=debug
```

## ğŸ“ é…ç½®æ–‡ä»¶ç¤ºä¾‹

å¦‚æœæ‚¨éœ€è¦åˆ›å»ºæ–°çš„é…ç½®æ–‡ä»¶ï¼Œå¯ä»¥å‚è€ƒä»¥ä¸‹æ¨¡æ¿ï¼š

```python
# configs/mapsage_v4_eval_config.py ç¤ºä¾‹
_base_ = [
    '_base_/models/segformer_mit-b2.py',
    '_base_/datasets/loveda.py',
    '_base_/default_runtime.py',
    '_base_/schedules/schedule_160k.py'
]

# æ¨¡å‹é…ç½®
model = dict(
    type='EncoderDecoder',
    backbone=dict(
        type='MixVisionTransformer',
        in_channels=3,
        embed_dims=64,
        num_stages=4,
        num_layers=[3, 4, 6, 3],
        num_heads=[1, 2, 5, 8],
        patch_sizes=[7, 3, 3, 3],
        sr_ratios=[8, 4, 2, 1],
        out_indices=(0, 1, 2, 3),
        mlp_ratio=4,
        qkv_bias=True,
        drop_rate=0.0,
        attn_drop_rate=0.0,
        drop_path_rate=0.1
    ),
    decode_head=dict(
        type='SegformerHead',
        in_channels=[64, 128, 320, 512],
        in_index=[0, 1, 2, 3],
        channels=256,
        dropout_ratio=0.1,
        num_classes=7,
        norm_cfg=dict(type='SyncBN', requires_grad=True),
        align_corners=False,
        loss_decode=dict(
            type='CrossEntropyLoss', use_sigmoid=False, loss_weight=1.0
        )
    ),
    train_cfg=dict(),
    test_cfg=dict(mode='slide', crop_size=(1024, 1024), stride=(768, 768))
)

# æ•°æ®é›†é…ç½®
dataset_type = 'LoveDADataset'
data_root = 'data/LoveDA'
img_norm_cfg = dict(
    mean=[123.675, 116.28, 103.53],
    std=[58.395, 57.12, 57.375],
    to_rgb=True
)

# å…¶ä»–é…ç½®...
```

## ğŸ¤ æŠ€æœ¯æ”¯æŒ

å¦‚æœæ‚¨åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜ï¼Œè¯·æ£€æŸ¥ï¼š

1. **ç¯å¢ƒé…ç½®**: ç¡®ä¿æ‰€æœ‰ä¾èµ–åŒ…æ­£ç¡®å®‰è£…
2. **æ–‡ä»¶è·¯å¾„**: æ£€æŸ¥æ¨¡å‹æƒé‡å’Œé…ç½®æ–‡ä»¶è·¯å¾„
3. **ç³»ç»Ÿèµ„æº**: ç¡®ä¿æœ‰è¶³å¤Ÿçš„å†…å­˜å’Œå­˜å‚¨ç©ºé—´
4. **Pythonç‰ˆæœ¬**: å»ºè®®ä½¿ç”¨Python 3.8-3.11

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®åŸºäºMapSage V4è®­ç»ƒè®¡åˆ’å¼€å‘ï¼Œç”¨äºå­¦æœ¯ç ”ç©¶å’ŒæŠ€æœ¯éªŒè¯ã€‚

## ğŸ”„ æ›´æ–°æ—¥å¿—

- **v1.0.0** (2025-01): åˆå§‹ç‰ˆæœ¬ï¼Œæ”¯æŒåŸºæœ¬çš„åˆ†å‰²åŠŸèƒ½
- æ”¯æŒLoveDAæ•°æ®é›†çš„7ä¸ªåœ°ç‰©ç±»åˆ«
- é›†æˆæ»‘çª—æ¨ç†å’Œç»“æœå¯è§†åŒ–
- æ·»åŠ ç±»åˆ«ç»Ÿè®¡å’Œä¸‹è½½åŠŸèƒ½

---

**ç¥æ‚¨ä½¿ç”¨æ„‰å¿«ï¼** ğŸ‰

å¦‚æœè¿™ä¸ªåº”ç”¨å¸®åŠ©æ‚¨éªŒè¯äº†æ¨¡å‹æ•ˆæœï¼Œæ¬¢è¿åˆ†äº«æ‚¨çš„ä½¿ç”¨ä½“éªŒå’Œæ”¹è¿›å»ºè®®ã€‚